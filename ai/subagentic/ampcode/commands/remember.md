---
name: remember
description: Consolidate stashes + friction into project memory
usage: /remember
---

Consolidate session stashes and friction analysis into a single project-local MEMORY.md, then inject into AGENT.md.

**Guardrails**
- Favor straightforward, minimal implementations first and add complexity only when requested or clearly required.
- Keep changes tightly scoped to the requested outcome.

**What it does**

Reads all raw material (`.amp/stash/*.md` + `.amp/friction/antigen_clusters.json`), extracts durable facts, episodes, and behavioral preferences into a single `.amp/memory/MEMORY.md`, then injects a managed memory section into `AGENT.md`.

**Steps**

1. **Gather sources**
   - Read all `.amp/stash/*.md` files in the current project
   - Check for friction output at `.amp/friction/antigen_clusters.json` (preferred) or `.amp/friction/antigen_review.md` (fallback)
   - Read existing `.amp/memory/MEMORY.md` if it exists — create dir if missing
   - Read processed manifest at `.amp/memory/.processed` — skip already-processed stashes
   - If no unprocessed stashes, report "nothing to consolidate" and stop

2. **Extract from unprocessed stashes** (use Task tool with sonnet model for each)
   - For each unprocessed stash, call sonnet to extract:
     - **FACTS** (atomic, one-line): stable preferences, decisions, corrections, explicit "remember this"
     - **EPISODE** (3-5 bullet narrative): what was the goal, what was tried, outcome, lesson
     - **SKIP**: code details, file paths, errors, mechanical steps, LLM responses
   - Collect all new facts and episodes

3. **Merge into MEMORY.md**
   - Read existing `.amp/memory/MEMORY.md` and parse its three sections (## Facts, ## Episodes, ## Preferences)
   - **Facts section**: call sonnet with existing facts + newly extracted facts
     - Rules: new updates replace old, contradictions keep new version, duplicates dropped
     - Keep facts atomic, one line each
   - **Episodes section**: append new episode entries (append-only, timestamped, no dedup)
   - **Preferences section**: only update if friction output exists (step 4)
   - Write merged result to `.amp/memory/MEMORY.md` in this format:

   ```markdown
   # Project Memory
   > Auto-generated by /remember. Do not edit manually.

   ## Facts
   - [atomic fact 1]
   - [atomic fact 2]

   ## Episodes
   ### YYYY-MM-DD - [title]
   - [bullet narrative]

   ### YYYY-MM-DD - [title]
   - [bullet narrative]

   ## Preferences
   ### High Confidence
   - [pattern] (evidence: [count] observations)

   ### Medium Confidence
   - [pattern] (evidence: [count] observations)

   ### Low Confidence
   - [pattern] (evidence: [count] observations)
   ```

4. **Distill friction into preferences** (only if friction output exists)
   - Read `.amp/friction/antigen_clusters.json` — this contains clustered failure patterns with counts, user_context quotes, and tool sequences
   - For the **top 10 clusters** (by score), extract the `contexts` field — these are the actual user messages that show behavioral patterns
   - Call sonnet with:
     - The top 10 clusters (signal, tool_pattern, count, sessions, contexts, errors)
     - Existing Preferences section from MEMORY.md
   - Extract BEHAVIORAL preferences (patterns demonstrated, not stated) — the user_context quotes are the primary evidence
   - Confidence tiers:
     - **High Confidence**: 5+ observations — available via @MEMORY.md
     - **Medium Confidence**: 3+ observations — observing, not loaded
     - **Low Confidence**: <3 observations — needs more data
   - Promote/demote based on new evidence
   - Update the Preferences section in MEMORY.md

5. **Inject memory reference into AGENT.md**
   - Compose the section between `<!-- MEMORY:START -->` and `<!-- MEMORY:END -->` markers:
     ```
     <!-- MEMORY:START -->
     @MEMORY.md
     <!-- MEMORY:END -->
     ```
   - The `@MEMORY.md` reference points to `.amp/memory/MEMORY.md` — Claude loads the full file directly, so no inline duplication is needed
   - If AGENT.md already has MEMORY markers, replace the section between them
   - If AGENT.md has no MEMORY markers, append the section at the end
   - If no AGENT.md exists, create one with just the memory section

6. **Update processed manifest**
   - Append paths of newly processed stashes to `.amp/memory/.processed`

7. **Report to user**
   - Number of stashes processed
   - Facts count (total, new)
   - Episodes count (total, new)
   - Preferences count by confidence tier
   - Confirm MEMORY.md and AGENT.md updated

**File locations (all project-local)**
- Memory file: `.amp/memory/MEMORY.md` (single source of truth, referenced as @MEMORY.md)
- Stash files: `.amp/stash/*.md`
- Friction output: `.amp/friction/antigen_clusters.json` (clustered patterns with user contexts)
- Friction fallback: `.amp/friction/antigen_review.md` (human-readable clusters)
- Processed manifest: `.amp/memory/.processed`
- Output: `AGENT.md` (managed MEMORY section with @MEMORY.md reference)
